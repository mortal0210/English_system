<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯è®°å¿†æ³¡æ³¡å¤§å†’é™©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        .back-home {
            position: fixed;
            top: 16px;
            left: 16px;
            padding: 6px 14px;
            border-radius: 999px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 0.9em;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        
        .back-home:hover {
            background: #fff;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
            overflow: auto;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            overflow: visible;
            position: relative;
            z-index: 1;
            margin: 20px auto;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe, #00f2fe); /* æ”¹ä¸ºæ‚¨å–œæ¬¢çš„é¢œè‰²ç»„åˆ */
            /* background-color: linear-gradient(135deg, #3494e6, #ec6ead); */
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, #ff0000, #0000ff, #00ff00, #ffff00);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            z-index: -1;
            filter: blur(20px);
            opacity: 0.3;
        }
        
        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background-color: #f0f4ff;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            color: #2c3e50;
            flex-wrap: wrap;
        }
        
        .stat-box {
            text-align: center;
            padding: 10px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            min-width: 120px;
            margin: 5px;
        }
        
        .stat-value {
            font-size: 1.8em;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .control-panel {
            padding: 25px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* .number-input {
            padding: 14px;
            border: 2px solid #4facfe;
            border-radius: 10px;
            font-size: 1.1em;
            outline: none;
            width: 120px;
            text-align: center;
        }
        
        .number-input:focus {
            border-color: #00f2fe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        } */

        .number-input {
            padding: 12px 16px;
            border: 2px solid #4facfe;
            border-radius: 8px;
            font-size: 1.1em;
            outline: none;
            width: 80px;
            text-align: center;
            background: white;
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.2);
            transition: all 0.3s ease;
        }
        .number-input:focus {
            border-color: #00f2fe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.3);
            transform: translateY(-2px);
        }
        
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff758c, #ff7eb3);
            color: white;
        }
        
        /* é¢„ç•™å…¶ä»–æŒ‰é’®é…è‰²ï¼ˆå¦‚éœ€è¦æ—¶å¯ç”¨ï¼‰
           background: linear-gradient(135deg, #ffd166, #ff9e01);
           color: white;
        */
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(0,0,0,0.1);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .game-container {
            position: relative;
            min-height: 400px;
            height: 50vh;
            max-height: 500px;
            overflow: hidden;
            background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
        }
        
        .center-word {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10;
            min-width: 250px;
            max-width: 90%;
        }
        
        .bubble {
            position: absolute;
            padding: 12px 20px;
            border-radius: 50%; /* æ”¹ä¸ºçƒå½¢ */
            background: rgba(255, 255, 255, 0.7); /* åŠé€æ˜æ•ˆæœ */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.3s;
            font-size: 1.1em;
            font-weight: bold;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-width: 80px; /* æœ€å°å®½åº¦ */
            min-height: 80px; /* ä¿è¯çƒå½¢ */
            max-width: 200px; /* æœ€å¤§å®½åº¦ */
            word-break: break-word; /* é•¿æ–‡æœ¬æ¢è¡Œ */
        }
        
        .bubble:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.9); /* æ‚¬åœæ—¶å¢åŠ é€æ˜åº¦ */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        .bubble.correct {
            background: rgba(67, 233, 123, 0.7); /* åŠé€æ˜ç»¿è‰² */
            color: white;
            animation: pop 0.5s forwards;
        }

        .bubble.wrong {
            background: rgba(255, 117, 140, 0.7); /* åŠé€æ˜çº¢è‰² */
            color: white;
            animation: shake 0.5s forwards;
        }
        
        .correct-hint {
            padding: 10px 20px;
            border-radius: 20px;
            background: rgba(46, 204, 113, 0.9); /* ç»¿è‰²èƒŒæ™¯ */
            color: white;
            font-size: 1.3em;
            font-weight: bold;
            z-index: 15;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: pulse 1s infinite;
            white-space: nowrap; /* é˜²æ­¢æ¢è¡Œ */
        }

        .timer-container {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1.3em;
            z-index: 20;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .timer-warning {
            animation: pulse 1s infinite;
            background: linear-gradient(135deg, #ff758c, #ff7eb3);
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            text-align: center;
        }
        
        .game-over h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #ffd166;
        }
        
        .game-over p {
            font-size: 1.3em;
            margin-bottom: 30px;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .mode-btn {
            padding: 12px 20px;
            border-radius: 30px;
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .mode-btn.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .explosion {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffd166;
            box-shadow: 0 0 20px #ff9e01;
            opacity: 0;
            z-index: 4;
            pointer-events: none;
        }
        
        .buttons-container {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .progress-container {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            z-index: 10;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            color: #2c3e50;
            font-weight: bold;
            font-size: 1.1em;
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50% }
            50% { background-position: 100% 50% }
            100% { background-position: 0% 50% }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(0); opacity: 0; }
        }
        
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }
        
        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(3); opacity: 0.7; }
            100% { transform: scale(5); opacity: 0; }
        }
        
        @keyframes float {
            0% { transform: translateY(0) translateX(0); }
            50% { transform: translateY(-20px) translateX(10px); }
            100% { transform: translateY(0) translateX(0); }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .stats-bar {
                flex-direction: row;
                gap: 5px;
            }
            
            .stat-box {
                min-width: 90px;
                padding: 8px;
            }
            
            .stat-value {
                font-size: 1.5em;
            }
            
            .btn {
                padding: 12px 18px;
                font-size: 1em;
            }
            
            .center-word {
                font-size: 2em;
                min-width: 200px;
                padding: 15px;
            }
            
            .bubble {
                padding: 10px 16px;
                font-size: 1em;
                min-width: 70px;
                min-height: 70px;
                max-width: 150px;
            }
            
            .game-container {
                height: 40vh;
                min-height: 350px;
            }
            
            .timer-container {
                font-size: 1.1em;
                padding: 10px 16px;
            }
            
            .mode-btn {
                padding: 10px 16px;
                font-size: 0.9em;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .control-panel {
                padding: 15px;
            }
            
            .number-input {
                width: 100px;
                padding: 12px;
            }
            
            .game-container {
                height: 35vh;
                min-height: 300px;
            }
            
            .center-word {
                font-size: 1.7em;
                min-width: 180px;
            }
            
            .stat-box {
                min-width: 70px;
                padding: 5px;
            }
            
            .stat-value {
                font-size: 1.3em;
            }
            
            .stat-label {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <button class="back-home" onclick="window.location.href = '/index.html';">â† è¿”å›é¦–é¡µ</button>
    <div class="container">
        <div class="header">
            <h1>ğŸ® å•è¯æ³¡æ³¡é¾™</h1>
            <p>åœ¨æ³¡æ³¡æµ·æ´‹ä¸­æŒ‘æˆ˜ä½ çš„è¯æ±‡è®°å¿†èƒ½åŠ›ï¼</p>
        </div>
        
        <div class="stats-bar">
            <div class="stat-box">
                <div class="stat-value" id="score">0</div>
                <div class="stat-label">å¾—åˆ†</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="correct-count">0</div>
                <div class="stat-label">æ­£ç¡®</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="wrong-count">0</div>
                <div class="stat-label">é”™è¯¯</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="streak">0</div>
                <div class="stat-label">è¿èƒœ</div>
            </div>
        </div>
        
        <div class="control-panel">
            <div class="input-group">
                <input 
                    type="number" 
                    id="startIndexInput" 
                    class="number-input" 
                    placeholder="èµ·å§‹ç¼–å·" 
                    min="0" 
                    value="0"
                >
                <span>è‡³</span>
                <input 
                    type="number" 
                    id="endIndexInput" 
                    class="number-input" 
                    placeholder="ç»“æŸç¼–å·" 
                    min="1" 
                    value="10"
                >
            </div>
            
            <div class="input-group">
                <label for="optionCount" style="font-weight: bold; color: #2c3e50;">é€‰é¡¹æ•°é‡:</label>
                <input 
                    type="number" 
                    id="optionCount" 
                    class="number-input" 
                    min="2" 
                    max="8" 
                    value="4"
                >
            </div>
            
            <div class="mode-selector">
                <div class="mode-btn active" data-mode="word-to-chinese">
                    <i class="fas fa-language"></i> å•è¯â†’ä¸­æ–‡
                </div>
                <div class="mode-btn" data-mode="chinese-to-word">
                    <i class="fas fa-exchange-alt"></i> ä¸­æ–‡â†’å•è¯
                </div>
            </div>
            
            <button id="startGameBtn" class="btn btn-primary">
                <span>ğŸš€ğŸš€ å¼€å§‹æ¸¸æˆ</span>
            </button>
            
            <!-- æ·»åŠ éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
            <div class="music-control">
                <button id="playMusicBtn" class="btn btn-secondary">
                    <span>ğŸµ æ’­æ”¾éŸ³ä¹</span>
                </button>
                <button id="pauseMusicBtn" class="btn btn-secondary" style="display: none;">
                    <span>â¸ æš‚åœéŸ³ä¹</span>
                </button>
            </div>
        </div>
        
        <div class="game-container" id="gameContainer">
            <div class="timer-container" id="timer">60.00ç§’</div>
            <div class="progress-text" id="progressText">0/0</div>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="center-word" id="centerWord">å‡†å¤‡å¼€å§‹æ¸¸æˆ...</div>
            
            <!-- æ³¡æ³¡ä¼šé€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="buttons-container">
            <button id="continueBtn" class="btn btn-success" style="display: none;">
                <span>â¯â¯â¯ï¸ ç»§ç»­æ¸¸æˆ</span>
            </button>
            <button id="restartBtn" class="btn btn-warning">
                <span>ğŸ”„ğŸ”„ é‡æ–°å¼€å§‹</span>
            </button>
        </div>
    </div>

    <!-- æ·»åŠ éŸ³é¢‘å…ƒç´  -->
    <audio id="backgroundMusic" loop>
        <source src="./audio/music.mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
    </audio>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ¸¸æˆå…ƒç´ 
            const startIndexInput = document.getElementById('startIndexInput');
            const endIndexInput = document.getElementById('endIndexInput');
            const optionCountInput = document.getElementById('optionCount');
            const startGameBtn = document.getElementById('startGameBtn');
            const continueBtn = document.getElementById('continueBtn');
            const restartBtn = document.getElementById('restartBtn');
            const gameContainer = document.getElementById('gameContainer');
            const centerWord = document.getElementById('centerWord');
            const timerDisplay = document.getElementById('timer');
            const scoreDisplay = document.getElementById('score');
            const correctCountDisplay = document.getElementById('correct-count');
            const wrongCountDisplay = document.getElementById('wrong-count');
            const streakDisplay = document.getElementById('streak');
            const modeBtns = document.querySelectorAll('.mode-btn');
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');
            
            // æ·»åŠ éŸ³ä¹æ§åˆ¶å…ƒç´ 
            const backgroundMusic = document.getElementById('backgroundMusic');
            const playMusicBtn = document.getElementById('playMusicBtn');
            const pauseMusicBtn = document.getElementById('pauseMusicBtn');
            
            // æ¸¸æˆçŠ¶æ€
            let words = [];
            let usedWords = [];
            let wrongWords = [];
            let currentWord = null;
            let gameActive = false;
            let timer;
            let timeLeft = 60;
            let startTime;
            let score = 0;
            let correctCount = 0;
            let wrongCount = 0;
            let currentStreak = 0;
            let bestStreak = 0;
            let gameMode = 'word-to-chinese';
            let totalWords = 0;
            let completedWords = 0;
            let lastExplosionTime = 0;
            
            // å®‰å…¨åŒºåŸŸï¼ˆé¿å…é€‰é¡¹å‡ºç°åœ¨å•è¯ä¸‹æ–¹ï¼‰
            let safeZone = {
                x: 0,
                y: 0,
                width: 300,
                height: 200
            };
            
            // åˆå§‹åŒ–æ¸¸æˆ
            function initGame() {
                const startIndex = parseInt(startIndexInput.value);
                const endIndex = parseInt(endIndexInput.value);
                
                if (isNaN(startIndex) || startIndex < 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„èµ·å§‹ç¼–å·ï¼ˆâ‰¥0ï¼‰');
                    return false;
                }
                
                if (isNaN(endIndex) || endIndex <= startIndex) {
                    alert('ç»“æŸç¼–å·å¿…é¡»å¤§äºèµ·å§‹ç¼–å·');
                    return false;
                }
                
                // è·å–è¯¾æœ¬åç§°å‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const bookname = urlParams.get('bookname');
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                centerWord.textContent = "æ­£åœ¨åŠ è½½è¯æ±‡æ•°æ®...";
                
                // æ„å»ºå¸¦å‚æ•°çš„URL
                // let url = `http://localhost:8080/english/list?start=${startIndex}&end=${endIndex}`;
                let url = `http://localhost:8080/english/list?start=${startIndex}&end=${endIndex}`;
                if (bookname) {
                    url += `&bookname=${encodeURIComponent(bookname)}`;
                }
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.code !== 1 || !data.data || data.data.length === 0) {
                            centerWord.textContent = "æš‚æ— è¯æ±‡æ•°æ®";
                            return;
                        }
                        
                        words = data.data;
                        totalWords = words.length;
                        completedWords = 0;
                        updateProgress();
                        usedWords = [];
                        wrongWords = [];
                        
                        startGame();
                    })
                    .catch(error => {
                        console.error('è·å–æ•°æ®å¤±è´¥:', error);
                        centerWord.textContent = "æ•°æ®åŠ è½½å¤±è´¥";
                    });
                    
                return true;
            }
            
            // å¼€å§‹æ¸¸æˆ
            function startGame() {
                resetGameStats();
                gameActive = true;
                startGameBtn.style.display = 'none';
                continueBtn.style.display = 'none';
                lastExplosionTime = 0;
                
                // æ›´æ–°å®‰å…¨åŒºåŸŸä½ç½®
                updateSafeZone();
                
                // å¼€å§‹è®¡æ—¶
                startTimer();
                
                // ç”Ÿæˆä¸‹ä¸€ä¸ªå•è¯
                generateNextWord();
            }
            
            // æ›´æ–°å®‰å…¨åŒºåŸŸï¼ˆé¿å…é€‰é¡¹å‡ºç°åœ¨å•è¯ä¸‹æ–¹ï¼‰
            function updateSafeZone() {
                const rect = centerWord.getBoundingClientRect();
                const containerRect = gameContainer.getBoundingClientRect();
                
                safeZone = {
                    x: rect.left - containerRect.left - 50,
                    y: rect.top - containerRect.top - 50,
                    width: rect.width + 100,
                    height: rect.height + 100
                };
            }
            
            // æ£€æŸ¥ä½ç½®æ˜¯å¦åœ¨å®‰å…¨åŒºåŸŸå†…
            function isInSafeZone(x, y) {
                return (
                    x > safeZone.x && 
                    x < safeZone.x + safeZone.width &&
                    y > safeZone.y &&
                    y < safeZone.y + safeZone.height
                );
            }
            
            // ç»§ç»­æ¸¸æˆ
            function continueGame() {
                gameActive = true;
                continueBtn.style.display = 'none';
                timeLeft = 60;
                startTimer();
                generateNextWord();
            }
            
            // é‡ç½®æ¸¸æˆç»Ÿè®¡
            function resetGameStats() {
                score = 0;
                correctCount = 0;
                wrongCount = 0;
                currentStreak = 0;
                bestStreak = 0;
                timeLeft = 60;
                completedWords = 0;
                
                updateStats();
                updateTimerDisplay();
                updateProgress();
            }
            
            // æ›´æ–°è¿›åº¦
            function updateProgress() {
                const progress = totalWords > 0 ? Math.round((completedWords / totalWords) * 100) : 0;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${completedWords}/${totalWords}`;
            }
            
            // å¼€å§‹è®¡æ—¶å™¨
            function startTimer() {
                startTime = Date.now();
                updateTimerDisplay();
                
                function update() {
                    if (!gameActive) return;
                    
                    const elapsed = (Date.now() - startTime) / 1000;
                    timeLeft = Math.max(0, 60 - elapsed);
                    
                    updateTimerDisplay();
                    
                    // æœ€å10ç§’è­¦å‘Šï¼ˆæ§åˆ¶é¢‘ç‡ï¼‰
                    if (timeLeft <= 10) {
                        timerDisplay.classList.add('timer-warning');
                        
                        const now = Date.now();
                        if (now - lastExplosionTime > 2000) { // æ¯2ç§’ä¸€ä¸ªçˆ†ç‚¸
                            createExplosion();
                            lastExplosionTime = now;
                        }
                    } else {
                        timerDisplay.classList.remove('timer-warning');
                    }
                    
                    if (timeLeft <= 0) {
                        endGame('æ—¶é—´ç»“æŸ');
                        return;
                    }
                    
                    requestAnimationFrame(update);
                }
                
                update();
            }
            
            // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
            function updateTimerDisplay() {
                timerDisplay.textContent = `${timeLeft.toFixed(2)}ç§’`;
            }
            
            // ç”Ÿæˆä¸‹ä¸€ä¸ªå•è¯
            function generateNextWord() {
                // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
                if (completedWords >= totalWords && wrongWords.length === 0) {
                    endGame('æ‰€æœ‰å•è¯å·²å®Œæˆ');
                    return;
                }
                
                // æ¸…é™¤æ‰€æœ‰æ³¡æ³¡
                clearBubbles();
                
                // æ›´æ–°å®‰å…¨åŒºåŸŸä½ç½®
                updateSafeZone();
                
                // ä¼˜å…ˆä»é”™è¯¯å•è¯ä¸­é€‰æ‹©
                if (wrongWords.length > 0) {
                    currentWord = wrongWords.pop();
                } else {
                    // ä»å‰©ä½™å•è¯ä¸­éšæœºé€‰æ‹©
                    const availableWords = words.filter(word => !usedWords.includes(word.id));
                    
                    if (availableWords.length === 0) {
                        endGame('æ‰€æœ‰å•è¯å·²å®Œæˆ');
                        return;
                    }
                    
                    const randomIndex = Math.floor(Math.random() * availableWords.length);
                    currentWord = availableWords[randomIndex];
                    usedWords.push(currentWord.id);
                }
                
                // æ˜¾ç¤ºä¸­å¿ƒå•è¯
                if (gameMode === 'word-to-chinese') {
                    centerWord.textContent = currentWord.word;
                } else {
                    centerWord.textContent = currentWord.chinese;
                }
                
                // ç”Ÿæˆæ³¡æ³¡é€‰é¡¹
                generateBubbles();
            }
            
            // ç”Ÿæˆæ³¡æ³¡é€‰é¡¹
            function generateBubbles() {
                const optionCount = parseInt(optionCountInput.value);
                if (isNaN(optionCount) || optionCount < 2) return;
                
                // è·å–æ‰€æœ‰å•è¯ï¼ˆé™¤äº†å½“å‰å•è¯ï¼‰
                const otherWords = words.filter(word => word.id !== currentWord.id);
                
                // éšæœºé€‰æ‹©é”™è¯¯é€‰é¡¹
                const wrongOptions = [];
                const shuffledWords = [...otherWords];
                shuffleArray(shuffledWords);
                
                for (let i = 0; i < Math.min(optionCount - 1, shuffledWords.length); i++) {
                    wrongOptions.push(shuffledWords[i]);
                }
                
                // åˆ›å»ºæ­£ç¡®é€‰é¡¹
                const correctOption = document.createElement('div');
                correctOption.className = 'bubble';
                if (gameMode === 'word-to-chinese') {
                    correctOption.textContent = currentWord.chinese;
                } else {
                    correctOption.textContent = currentWord.word;
                }
                correctOption.dataset.correct = 'true';
                
                // åˆ›å»ºé”™è¯¯é€‰é¡¹
                const optionElements = wrongOptions.map(option => {
                    const bubble = document.createElement('div');
                    bubble.className = 'bubble';
                    if (gameMode === 'word-to-chinese') {
                        bubble.textContent = option.chinese;
                    } else {
                        bubble.textContent = option.word;
                    }
                    bubble.dataset.correct = 'false';
                    return bubble;
                });
                
                // æ·»åŠ æ­£ç¡®é€‰é¡¹
                optionElements.push(correctOption);
                
                // éšæœºæ’åºé€‰é¡¹
                shuffleArray(optionElements);
                
                // å®šä½æ³¡æ³¡ï¼ˆé¿å¼€å®‰å…¨åŒºåŸŸï¼‰
                positionBubbles(optionElements);
            }
            
            // å®šä½æ³¡æ³¡ï¼ˆé¿å¼€å®‰å…¨åŒºåŸŸï¼‰
            function positionBubbles(bubbles) {
                const positions = []; 
                const containerRect = gameContainer.getBoundingClientRect();
                const padding = 20; // é¿å…å¤ªé è¿‘è¾¹ç¼˜
                
                bubbles.forEach((bubble, index) => {
                    let position;
                    let overlap;
                    let attempts = 0;
                    // æ ¹æ®å†…å®¹åŠ¨æ€è°ƒæ•´æ³¡æ³¡å¤§å°
                    const textLength = bubble.textContent.length;
                    const bubbleSize = Math.max(80, Math.min(150, textLength * 10)); // æ ¹æ®æ–‡æœ¬é•¿åº¦è°ƒæ•´å¤§å°
                    const bubbleWidth = bubbleSize;
                    const bubbleHeight = bubbleSize;
                    
                    do {
                        overlap = false;
                        
                        // éšæœºä½ç½®ï¼ˆç¡®ä¿åœ¨å®¹å™¨å†…ï¼‰
                        const top = padding + Math.random() * (containerRect.height - padding * 2 - bubbleHeight);
                        const left = padding + Math.random() * (containerRect.width - padding * 2 - bubbleWidth);
                        
                        position = { top, left };
                        
                        // æ£€æŸ¥æ˜¯å¦åœ¨å®‰å…¨åŒºåŸŸå†…
                        if (isInSafeZone(left + bubbleWidth/2, top + bubbleHeight/2)) {
                            overlap = true;
                            continue;
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–æ³¡æ³¡é‡å 
                        for (const otherPos of positions) {
                            const dx = otherPos.left - left;
                            const dy = otherPos.top - top;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            // å¦‚æœè·ç¦»å°äº120pxï¼Œè®¤ä¸ºé‡å 
                            if (distance < 120) {
                                overlap = true;
                                break;
                            }
                        }
                        
                        attempts++;
                    } while (overlap && attempts < 100);
                    
                    positions.push(position);
                    
                    // è®¾ç½®æ³¡æ³¡ä½ç½®
                    Object.assign(bubble.style, {
                        top: `${position.top}px`,
                        left: `${position.left}px`,
                        position: 'absolute'
                    });
                    
                    // æ·»åŠ æµ®åŠ¨åŠ¨ç”»
                    bubble.style.animation = `float ${3 + Math.random() * 2}s infinite ease-in-out`;
                    bubble.style.animationDelay = `${index * 0.2}s`;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    bubble.addEventListener('click', handleBubbleClick);
                    
                    gameContainer.appendChild(bubble);
                });
            }
            
            // å¤„ç†æ³¡æ³¡ç‚¹å‡»
            function handleBubbleClick(e) {
                if (!gameActive) return;
                
                const bubble = e.target;
                const isCorrect = bubble.dataset.correct === 'true';
                
                if (isCorrect) {
                    // æ­£ç¡®ç­”æ¡ˆ
                    bubble.classList.add('correct');
                    score += 10;
                    correctCount++;
                    currentStreak++;
                    completedWords++;
                    
                    if (currentStreak > bestStreak) {
                        bestStreak = currentStreak;
                    }
                    
                    // è¿å‡»å¥–åŠ±
                    if (currentStreak >= 3) {
                        score += currentStreak * 2;
                    }
                    
                    // å»¶è¿Ÿåè¿›å…¥ä¸‹ä¸€ä¸ªå•è¯
                    setTimeout(() => {
                        generateNextWord();
                        updateProgress();
                    }, 300);
                } else {
                    // é”™è¯¯ç­”æ¡ˆ
                    bubble.classList.add('wrong');
                    wrongCount++;
                    currentStreak = 0;
                    
                    // åœ¨ä¸­å¿ƒå•è¯ä¸‹æ–¹æ˜¾ç¤ºç»¿è‰²æ­£ç¡®ç­”æ¡ˆæç¤º
                    const correctAnswerText = gameMode === 'word-to-chinese' 
                        ? currentWord.chinese 
                        : currentWord.word;
                    
                    // åˆ›å»ºæç¤ºå…ƒç´ 
                    const correctHint = document.createElement('div');
                    correctHint.className = 'correct-hint';
                    correctHint.textContent = `æ­£ç¡®ç­”æ¡ˆ: ${correctAnswerText}`;
                    
                    // å°†æç¤ºæ·»åŠ åˆ°æ¸¸æˆå®¹å™¨ä¸­
                    gameContainer.appendChild(correctHint);
                    
                    // å®šä½åœ¨ä¸­å¿ƒå•è¯ä¸‹æ–¹
                    const centerRect = centerWord.getBoundingClientRect();
                    const containerRect = gameContainer.getBoundingClientRect();
                    const top = centerRect.bottom - containerRect.top + 10;
                    const left = centerRect.left - containerRect.left;
                    
                    Object.assign(correctHint.style, {
                        top: `${top}px`,
                        left: `${left}px`,
                        position: 'absolute'
                    });
                    
                    // å°†å½“å‰å•è¯æ·»åŠ åˆ°é”™è¯¯å•è¯åˆ—è¡¨ï¼ˆéšæœºä½ç½®ï¼‰
                    const randomIndex = Math.floor(Math.random() * (wrongWords.length + 1));
                    wrongWords.splice(randomIndex, 0, currentWord);
                    
                    // å»¶è¿Ÿåè¿›å…¥ä¸‹ä¸€ä¸ªå•è¯
                    setTimeout(() => {
                        correctHint.remove();
                        generateNextWord();
                    }, 1500);
                }
                
                updateStats();
            }
            
            // æ¸…é™¤æ‰€æœ‰æ³¡æ³¡
            function clearBubbles() {
                const bubbles = document.querySelectorAll('.bubble');
                bubbles.forEach(bubble => bubble.remove());
            }
            
            // åˆ›å»ºçˆ†ç‚¸æ•ˆæœ
            function createExplosion() {
                if (timeLeft > 0 && timeLeft <= 10) {
                    const explosion = document.createElement('div');
                    explosion.className = 'explosion';
                    
                    // éšæœºä½ç½®
                    explosion.style.left = `${Math.random() * 100}%`;
                    explosion.style.top = `${Math.random() * 100}%`;
                    
                    gameContainer.appendChild(explosion);
                    
                    // å¯åŠ¨çˆ†ç‚¸åŠ¨ç”»
                    explosion.style.animation = `explode 0.5s forwards`;
                    
                    // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
                    setTimeout(() => {
                        explosion.remove();
                    }, 500);
                }
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            function updateStats() {
                scoreDisplay.textContent = score;
                correctCountDisplay.textContent = correctCount;
                wrongCountDisplay.textContent = wrongCount;
                streakDisplay.textContent = currentStreak;
            }
            
            // ç»“æŸæ¸¸æˆ
            function endGame(reason) {
                gameActive = false;
                timerDisplay.classList.remove('timer-warning');
                
                // æ˜¾ç¤ºæ¸¸æˆç»“æŸä¿¡æ¯
                const gameOverDiv = document.createElement('div');
                gameOverDiv.className = 'game-over';
                
                let title, message;
                if (reason === 'æ—¶é—´ç»“æŸ') {
                    title = 'æ—¶é—´åˆ°ï¼';
                    message = `æ—¶é—´ç»“æŸäº†ï¼Œä½ å®Œæˆäº† ${completedWords}/${totalWords} ä¸ªå•è¯`;
                } else {
                    title = 'æŒ‘æˆ˜å®Œæˆï¼';
                    message = `æ­å–œï¼ä½ å®Œæˆäº†æ‰€æœ‰ ${totalWords} ä¸ªå•è¯`;
                }
                
                gameOverDiv.innerHTML = `
                    <h2>${title}</h2>
                    <p>${message}</p>
                    <p>æœ€ç»ˆå¾—åˆ†: ${score}</p>
                    <p>æ­£ç¡®: ${correctCount} | é”™è¯¯: ${wrongCount}</p>
                    <p>æœ€é•¿è¿èƒœ: ${bestStreak}</p>
                `;
                
                gameContainer.appendChild(gameOverDiv);
                
                // æ˜¾ç¤ºç»§ç»­æ¸¸æˆæŒ‰é’®
                continueBtn.style.display = 'inline-block';
                startGameBtn.style.display = 'none';
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤æ¸¸æˆç»“æŸä¿¡æ¯
                setTimeout(() => {
                    gameOverDiv.remove();
                }, 3000);
            }
            
            // å·¥å…·å‡½æ•°ï¼šéšæœºæ‰“ä¹±æ•°ç»„
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }
            
            // äº‹ä»¶ç›‘å¬å™¨
            startGameBtn.addEventListener('click', function() {
                if (initGame()) {
                    startGameBtn.style.display = 'none';
                }
            });
            
            continueBtn.addEventListener('click', continueGame);
            
            restartBtn.addEventListener('click', function() {
                // æ¸…é™¤æ¸¸æˆåŒºåŸŸ
                clearBubbles();
                const gameOverDiv = document.querySelector('.game-over');
                if (gameOverDiv) gameOverDiv.remove();
                
                // é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
                if (initGame()) {
                    continueBtn.style.display = 'none';
                }
            });
            
            // æ¨¡å¼åˆ‡æ¢
            modeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    modeBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    gameMode = this.dataset.mode;
                });
            });
            
            // æ·»åŠ éŸ³ä¹æ§åˆ¶äº‹ä»¶ç›‘å¬å™¨
            playMusicBtn.addEventListener('click', function() {
                backgroundMusic.play();
                playMusicBtn.style.display = 'none';
                pauseMusicBtn.style.display = 'inline-block';
            });
            
            pauseMusicBtn.addEventListener('click', function() {
                backgroundMusic.pause();
                pauseMusicBtn.style.display = 'none';
                playMusicBtn.style.display = 'inline-block';
            });
            
        });
    </script>
</body>
</html>